CREATE PROC sp_GetAllLichSuTiem (@MAKH CHAR(10))
AS
BEGIN
	SELECT pt.NGAYTIEM, vc.TENVACCINE, lvc.LOAIVACCINE, vc.NHASX, ctt.MUITHU, ctt.LIEULUONG, ctt.NGAYTIEMNHACLAI, vc.DONGIA
    FROM dbo.KHACHHANG kh INNER JOIN dbo.PHIEUTIEM pt INNER JOIN dbo.CHITIETTIEM ctt INNER JOIN dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc
	ON VC.MALOAIVC = lvc.MALOAIVC
    ON vc.MAVACCINE = ctt.MAVACCINE
    ON ctt.MAPHIEUTIEM = pt.MAPHIEUTIEM
    ON pt.MAKH = kh.MAKH
    WHERE kh.MAKH = @MAKH
END
GO



CREATE PROC sp_GetTenThuNgan (@MATHUNGAN char(10))
AS
BEGIN
	SELECT HOTEN FROM THUNGAN WHERE MATHUNGAN = @MATHUNGAN
END
GO



CREATE PROC sp_GetAllVaccine
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
END
GO



CREATE PROC sp_SearchAllVaccine (@Value NVARCHAR(100))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
    WHERE vc.MAVACCINE LIKE N'%' + @Value + '%'
    OR vc.TENVACCINE LIKE N'%' + @Value + '%'
    OR vc.NHASX LIKE N'%' + @Value + '%'
    OR vc.NGAYSX LIKE N'%' + @Value + '%'
    OR vc.HANSD  LIKE N'%' + @Value + '%'
    OR vc.SOLO LIKE N'%' + @Value + '%'
    OR vc.SOLUONGCOSAN LIKE N'%' + @Value + '%'
    OR lvc.LOAIVACCINE LIKE N'%' + @Value + '%'
    OR vc.DONGIA LIKE N'%' + @Value + '%'
END
GO


CREATE PROC sp_SearchByMaVC (@Value NVARCHAR(100))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
    WHERE vc.MAVACCINE LIKE N'%' + @Value + '%'
END
GO


CREATE PROC sp_SearchByTenVC (@Value NVARCHAR(100))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
    WHERE vc.TENVACCINE LIKE N'%' + @Value + '%'
END
GO


CREATE PROC sp_SearchByLoaiVC (@Value NVARCHAR(100))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
    WHERE lvc.LOAIVACCINE LIKE N'%' + @Value + '%'
END
GO


CREATE PROC sp_SearchByNhaSX (@Value NVARCHAR(100))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
    WHERE vc.NHASX LIKE N'%' + @Value + '%'
END
GO


CREATE PROC sp_IsVCInStock (@MAVACCINE CHAR(10))
AS
BEGIN
	DECLARE @returnVal int
	IF EXISTS (SELECT MAVACCINE FROM VACCINE WHERE MAVACCINE = @MAVACCINE)
	BEGIN
	    SET @returnVal = 1
	END
	ELSE SET @returnVal = 0
	RETURN @returnVal
END
GO



CREATE PROC sp_InsertPhieuTiem (@MAPHIEUTIEM CHAR(10), @NGAYTIEM DATE, @MAKH CHAR(10), @MABS CHAR(10)) 
AS
BEGIN
    INSERT INTO dbo.PHIEUTIEM
    (
        MAPHIEUTIEM,
        NGAYTIEM,
        MAKH,
        MABS
    )
    VALUES
    (   @MAPHIEUTIEM,        -- MAPHIEUTIEM - char(10)
        @NGAYTIEM, -- NGAYTIEM - date
        @MAKH,        -- MAKH - char(10)
        @MABS         -- MABS - char(10)
        )
END
GO	



CREATE PROC sp_InsertCTT (@MAPHIEUTIEM CHAR(10),@MAVACCINE CHAR(10), @GIABAN INT, @MUITHU INT, @NGAYNHACLAI DATE, @LIEULUONG FLOAT)
AS
BEGIN
    INSERT INTO dbo.CHITIETTIEM
    (
        MAPHIEUTIEM,
        MAVACCINE,
        GIABAN,
        MUITHU,
        NGAYTIEMNHACLAI,
        LIEULUONG
    )
    VALUES
    (   @MAPHIEUTIEM,        -- MAPHIEUTIEM - char(10)
        @MAVACCINE,        -- MAVACCINE - char(10)
        @GIABAN,         -- GIABAN - int
        @MUITHU,         -- MUITHU - int
        @NGAYNHACLAI, -- NGAYTIEMNHACLAI - date
        @LIEULUONG        -- LIEULUONG - float
        )
END
GO	


CREATE PROC sp_DeletePhieuTiem (@MAPHIEUTIEM CHAR(10))
AS	
BEGIN
    DELETE dbo.PHIEUTIEM WHERE MAPHIEUTIEM = @MAPHIEUTIEM
END
GO


CREATE PROC sp_GetPhieuTiemsInfo 
AS
BEGIN
    SELECT pt.MAPHIEUTIEM, kh.MAKH, kh.TENKH, kh.NGAYSINH, kh.GIOITINH, kh.TIEUSU, pt.NGAYTIEM, bs.HOTEN AS TENBS
	FROM dbo.BACSY bs INNER JOIN dbo.PHIEUTIEM pt INNER JOIN dbo.KHACHHANG kh
	ON kh.MAKH = pt.MAKH
	ON pt.MABS = bs.MABS
	ORDER BY pt.MAPHIEUTIEM DESC
END
GO	



CREATE PROC sp_UpdatePhieuTiemInfo (@MAPHIEUTIEM CHAR(10), @NGAYTIEM DATE, @TENKH NVARCHAR(50), @NGAYSINH DATE, @GIOITINH NVARCHAR(4), @TIEUSU NVARCHAR(250))
AS
BEGIN
    UPDATE dbo.PHIEUTIEM SET NGAYTIEM = @NGAYTIEM WHERE MAPHIEUTIEM = @MAPHIEUTIEM
	UPDATE dbo.KHACHHANG SET TENKH = @TENKH, NGAYSINH = @NGAYSINH, GIOITINH = @GIOITINH, TIEUSU = @TIEUSU WHERE MAKH IN
	(
		SELECT kh.MAKH FROM dbo.KHACHHANG kh INNER JOIN  dbo.PHIEUTIEM pt ON pt.MAKH = kh.MAKH WHERE pt.MAPHIEUTIEM = @MAPHIEUTIEM
	)
END
GO	

CREATE PROC sp_GetAllHoaDonInfo
AS
BEGIN
    SELECT hd.MAHOADON, hd.TONGTIEN, hd.CHIETKHAU, hd.NGAYTHU, ngh.HOTEN AS NGUOIGH, ngh.DIACHI, ngh.SDT, tn.HOTEN AS THUNGAN
	FROM dbo.THUNGAN tn INNER JOIN dbo.HOADON hd INNER JOIN dbo.NGUOIGIAMHO ngh
	ON ngh.MAGH = hd.MAGH
	ON hd.MATHUNGAN = tn.MATHUNGAN
END
GO	


CREATE PROC sp_GetMaPhieuTiemFromHD (@MAHOADON CHAR(10))
AS
BEGIN
    SELECT MAPHIEUTIEM FROM dbo.HOADON WHERE MAHOADON = @MAHOADON
END
GO	


CREATE PROC sp_DeleteHoaDon (@MAHOADON CHAR(10))
AS
BEGIN
    DELETE FROM dbo.HOADON WHERE MAHOADON = @MAHOADON
END
GO	


CREATE PROC sp_UpdateHoaDonInfo (@MAHOADON CHAR(10), @NGAYTHU DATE, @NGUOIGH NVARCHAR(50), @DIACHI NVARCHAR(100), @SDT VARCHAR(20))
AS
BEGIN
    UPDATE dbo.HOADON SET NGAYTHU = @NGAYTHU WHERE MAHOADON = @MAHOADON
	UPDATE dbo.NGUOIGIAMHO SET HOTEN = @NGUOIGH, DIACHI = @DIACHI, SDT = @SDT WHERE MAGH IN
	(
		SELECT HD.MAGH FROM dbo.NGUOIGIAMHO ngh INNER JOIN dbo.HOADON hd ON hd.MAGH = ngh.MAGH WHERE hd.MAHOADON = @MAHOADON
	)
END
GO	


CREATE PROC sp_InsertNGH (@MAGH CHAR(10), @HOTEN NVARCHAR(50), @DIACHI NVARCHAR(100), @SDT VARCHAR(20))
AS
BEGIN
    INSERT INTO dbo.NGUOIGIAMHO
    (
        MAGH,
        HOTEN,
        DIACHI,
        SDT
    )
    VALUES
    (   @MAGH,  -- MAGH - char(10)
        @HOTEN, -- HOTEN - nvarchar(50)
        @DIACHI, -- DIACHI - nvarchar(100)
        @SDT   -- SDT - varchar(20)
        )
END
GO	


CREATE PROC sp_AddMaGHtoKH (@MAGH CHAR(10))
AS
BEGIN
    UPDATE KHACHHANG SET MAGH = @MAGH WHERE MAKH IN (
	    SELECT kh.MAKH
	    FROM NGUOIGIAMHO gh INNER JOIN HOADON hd INNER JOIN PHIEUTIEM pt INNER JOIN KHACHHANG kh
	    ON kh.MAKH = pt.MAKH ON pt.MAPHIEUTIEM = hd.MAPHIEUTIEM ON hd.MAGH = gh.MAGH
	    WHERE gh.MAGH = @MAGH )
END
GO	


CREATE PROC sp_InsertHD (@MAHOADON CHAR(10), @CHIETKHAU FLOAT, @NGAYTHU DATE, @TONGTIEN BIGINT, @MAGH CHAR(10), @MATHUNGAN CHAR(10), @MAPHIEUTIEM CHAR(10))
AS
BEGIN
    INSERT INTO dbo.HOADON
    (
        MAHOADON,
        CHIETKHAU,
        NGAYTHU,
        TONGTIEN,
        MAGH,
        MATHUNGAN,
        MAPHIEUTIEM
    )
    VALUES
    (   @MAHOADON,        -- MAHOADON - char(10)
        @CHIETKHAU,       -- CHIETKHAU - float
        @NGAYTHU, -- NGAYTHU - date
        @TONGTIEN,         -- TONGTIEN - bigint
        @MAGH,        -- MAGH - char(10)
        @MATHUNGAN,        -- MATHUNGAN - char(10)
        @MAPHIEUTIEM         -- MAPHIEUTIEM - char(10)
        )
END
GO	


CREATE PROC sp_InsertKH (@MAKH CHAR(10), @TENKH NVARCHAR(50), @NGAYSINH DATE, @GIOITINH NVARCHAR(4), @TIEUSU NVARCHAR(250), @MAGH CHAR(10))
AS
BEGIN
    INSERT INTO dbo.KHACHHANG
    (
        MAKH,
        TENKH,
        NGAYSINH,
        GIOITINH,
        TIEUSU,
        MAGH
    )
    VALUES
    (   @MAKH,        -- MAKH - char(10)
        @TENKH,       -- TENKH - nvarchar(20)
        @NGAYSINH, -- NGAYSINH - date
        @GIOITINH,       -- GIOITINH - nvarchar(4)
        @TIEUSU,       -- TIEUSU - nvarchar(250)
        @MAGH         -- MAGH - char(10)
        )
END
GO	


CREATE PROC sp_CheckPaymentStatus (@MAPHIEUTIEM CHAR(10))
AS
BEGIN
    DECLARE @returnVal int
	IF EXISTS (SELECT * FROM dbo.PHIEUTIEM pt INNER JOIN dbo.HOADON hd ON hd.MAPHIEUTIEM = pt.MAPHIEUTIEM WHERE pt.MAPHIEUTIEM = @MAPHIEUTIEM)
	BEGIN
	    SET @returnVal = 1
	END
	ELSE SET @returnVal = 0
	RETURN @returnVal
END
GO	


CREATE PROC sp_GetVCFromPhieuTiem (@MAPHIEUTIEM CHAR(10))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, lvc.LOAIVACCINE, vc.NHASX, ctt.MUITHU, ctt.LIEULUONG, ctt.NGAYTIEMNHACLAI, vc.DONGIA
    FROM dbo.PHIEUTIEM pt INNER JOIN dbo.CHITIETTIEM ctt INNER JOIN dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc
	ON lvc.MALOAIVC = vc.MALOAIVC
    ON vc.MAVACCINE = ctt.MAVACCINE
    ON ctt.MAPHIEUTIEM = pt.MAPHIEUTIEM
    WHERE ctt.MAPHIEUTIEM = @MAPHIEUTIEM
END



--Dem so Vaccine cua moi LOAIVC:
GO
CREATE PROC sp_CountVCTheoLoaiVC
AS
BEGIN
	SELECT VACCINE.MALOAIVC AS 'Loai', SUM(SOLUONGCOSAN) AS 'SoLuong'
FROM dbo.VACCINE INNER JOIN dbo.LOAIVC ON LOAIVC.MALOAIVC = VACCINE.MALOAIVC
GROUP BY VACCINE.MALOAIVC
ORDER BY VACCINE.MALOAIVC ASC
END


--Lay list vaccine duoc dung nhieu nhat trong mot khoang thoi gian
GO
CREATE PROC sp_GetMostUsedVaccineINTIME (@NgayDau DATE, @NgayCuoi DATE)
AS
BEGIN	
		SELECT MAVACCINE AS 'MaVC', COUNT(MAVACCINE) AS 'SoLuong'
		FROM dbo.PHIEUTIEM INNER JOIN dbo.CHITIETTIEM ON CHITIETTIEM.MAPHIEUTIEM = PHIEUTIEM.MAPHIEUTIEM
		WHERE CHITIETTIEM.MAPHIEUTIEM IN
		(SELECT DISTINCT MAPHIEUTIEM FROM dbo.HOADON WHERE NGAYTHU BETWEEN @NgayDau AND @NgayCuoi)
		GROUP BY MAVACCINE
		ORDER BY SoLuong DESC
END


--Get hoa don trong 1 khoang thoi gian
go
CREATE PROC	sp_GetHoaDonINTIME_TK  (@NgayDau DATE, @NgayCuoi DATE)
AS
BEGIN
    SELECT NGAYTHU AS "Ngay", TONGTIEN AS "Tien"
	FROM dbo.HOADON
	WHERE NGAYTHU BETWEEN @NgayDau AND @NgayCuoi
	ORDER BY NGAYTHU ASC
END


--//////////////////////////////////////////////////////////////////////////

-- Cac PROC Report cho ThanhToan:

--get Thong Tin tu Hoa Don bang MaHoaDon
go
CREATE PROC spRP_getInforHoaDon (@maHD CHAR(10))
AS
BEGIN	
	SELECT 
		CHIETKHAU AS 'ChietKhau', 
		NGAYTHU AS 'NgayThu', 
		TONGTIEN AS 'TongTien',
		MAPHIEUTIEM AS 'MaPhieuTiem',
		MATHUNGAN AS 'MaThuNgan'
	FROM dbo.HOADON
	WHERE MAHOADON = @maHD
END
GO

--Get Thong Tin GiamHo cho Hoa don bang MaHD:
GO 
CREATE PROC spRP_GetInforNGH(@maHD CHAR(10))
AS
BEGIN
	SELECT HOTEN AS 'HoTen', DIACHI AS 'DiaChi', SDT AS 'SDT'
	FROM	dbo.NGUOIGIAMHO INNER JOIN dbo.HOADON ON HOADON.MAGH = NGUOIGIAMHO.MAGH
	WHERE
	(
		MAHOADON = @maHD
	)
END
GO

--Get Ngay Tiem bang Ma Phieu Tiem
GO
CREATE PROC spRP_GetNgayTiem(@maPhieuTiem CHAR(10))
AS
BEGIN
	SELECT NGAYTIEM AS 'NgayTiem'
	FROM dbo.PHIEUTIEM
	WHERE MAPHIEUTIEM = @maPhieuTiem
END
GO

--Get Ten Bac Si bang Ma Phieu Tiem:
GO
CREATE PROC spRP_GetTenBS(@maPhieuTiem CHAR(10))
AS
BEGIN
SELECT HOTEN AS 'HoTenBS'
FROM dbo.BACSY INNER JOIN dbo.PHIEUTIEM ON PHIEUTIEM.MABS = BACSY.MABS
WHERE MAPHIEUTIEM = @maPhieuTiem
END
GO

--Get MaVaccine tu Ma Phieu Tiem:
GO
CREATE PROC spRP_GetMaVC(@maPhieuTiem CHAR(10))
AS
BEGIN
	SELECT DISTINCT MAVACCINE AS 'MaVC'
	FROM dbo.CHITIETTIEM 
	WHERE MAPHIEUTIEM = @maPhieuTiem
END
GO

--Get Ten Cua Vaccine va Don Gia bang MaVC:
GO
CREATE PROC spRP_GetTen_GiaVC (@maVC CHAR(10))
AS
BEGIN
    SELECT TENVACCINE AS 'TenVC', DONGIA AS 'DonGiaVC'
	FROM dbo.VACCINE
	WHERE MAVACCINE = @maVC
END


--get Ten Thu Ngan bang MaThuNgan:
GO
CREATE PROC spRP_GetTenThuNgan (@maTN CHAR(10))
AS
BEGIN
    SELECT HOTEN AS 'HoTenTN'
	FROM dbo.THUNGAN
	WHERE MATHUNGAN = @maTN 
END


--Get ten Benh nhan bang MaPhieuTiem:
GO
CREATE PROC spRP_GetTenBenhNhan(@maPhieuTiem CHAR(10))
AS
BEGIN
	SELECT DISTINCT TENKH AS 'TenBN'
	FROM dbo.PHIEUTIEM INNER JOIN dbo.KHACHHANG ON	KHACHHANG.MAKH = PHIEUTIEM.MAKH
	WHERE MAPHIEUTIEM = @maPhieuTiem
END
go

-- Lay thong tin cho Report Phieu Tiem
CREATE PROC sp_GetPhieuTiemReportInfo (@MAPT CHAR(10))
AS
BEGIN
	DECLARE @tbBSPT TABLE (MAPT CHAR(10), NGAYTIEM DATE, TENBS NVARCHAR(50), MAKH CHAR(10))

	INSERT INTO @tbBSPT SELECT pt.MAPHIEUTIEM, pt.NGAYTIEM, bs.HOTEN, pt.MAKH FROM dbo.PHIEUTIEM pt INNER JOIN dbo.BACSY bs ON bs.MABS = pt.MABS WHERE pt.MAPHIEUTIEM = @MAPT

    SELECT bspt.NGAYTIEM, kh.MAKH, kh.TENKH, kh.NGAYSINH, kh.GIOITINH, kh.TIEUSU, bspt.TENBS FROM dbo.KHACHHANG kh INNER JOIN @tbBSPT bspt INNER JOIN dbo.CHITIETTIEM ctt INNER JOIN dbo.VACCINE vc
	ON vc.MAVACCINE = ctt.MAVACCINE
	ON bspt.MAPT = ctt.MAPHIEUTIEM
	ON kh.MAKH = bspt.MAKH
END


--********************
--Lay ten Loai VC theo ma Loai VC:
CREATE PROC sp_GetTenLoaiVCTheoMaLoai(@MaLoaiVC CHAR(10))
AS
BEGIN
	SELECT LOAIVACCINE AS 'TenLoaiVC'
	FROM dbo.LOAIVC
	WHERE MALOAIVC = @MaLoaiVC
END
--Lay Ten Vaccine tu loai VC:
GO
CREATE PROC sp_GetTenVCTuMaVC(@MaVC CHAR(10))
AS
BEGIN
	SELECT TENVACCINE AS 'TenVC'
	FROM dbo.VACCINE
	WHERE MAVACCINE = @MaVC
END


--Lay Doanh Thu Theo Ngay:
GO	
CREATE PROC sp_GetDoanhThuTheoNgayINTIME(@NgayDau DATE, @NgayCuoi DATE)
AS
BEGIN
    SELECT NGAYTHU AS "Ngay", SUM(TONGTIEN) AS "Tien"
	FROM dbo.HOADON
	WHERE NGAYTHU BETWEEN @NgayDau AND @NgayCuoi
	GROUP BY(NGAYTHU)
	ORDER BY NGAYTHU ASC
END